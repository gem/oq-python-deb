#! /bin/sh

set -e

if [ "$1" = configure ]; then
    files=$(dpkg -L lib@PVER@-dbg@HOST_QUAL@ | sed -n '/^\/opt\/openquake\/usr\/lib\/@PVER@\/.*\.py$/p')
    if [ -n "$files" ]; then
	/opt/openquake/usr/bin/@OPVER@ -E -S /opt/openquake//usr/lib/@OPVER@/py_compile.py $files
	if grep -sq '^byte-compile[^#]*optimize' /etc/python/debian_config; then
	    /opt/openquake/usr/bin/@OPVER@ -E -S -O /opt/openquake/usr/lib/@OPVER@/py_compile.py $files
	fi
    else
	echo >&2 "@PVER@-dbg: can't get files for byte-compilation"
    fi

  if [ -d /opt/openquake/usr/include/@OPVER@_d ] && [ ! -h /opt/openquake/usr/include/@OPVER@_d ]; then
    if rmdir /opt/openquake/usr/include/@OPVER@_d 2> /dev/null; then
      ln -sf @PVER@dmu /opt/openquake/usr/include/@OPVER@_d
    else
      echo >&2 "WARNING: non-empty directory on upgrade: /usr/include/@PVER@_d"
      ls -l /opt/openquake/usr/include/@OPVER@_d
    fi
  fi
  if [ -d /opt/openquake/usr/lib/@OPVER@/config_d ] && [ ! -h /opt/openquake/usr/lib/@OPVER@/config_d ]; then
    if rmdir /opt/openquake/usr/lib/@OPVER@/config_d 2> /dev/null; then
      ln -sf config-dmu /opt/openquake/usr/lib/@OPVER@/config_d
    else
      echo >&2 "WARNING: non-empty directory on upgrade: /usr/lib/@PVER@/config_d"
      ls -l /opt/openquake/usr/lib/@OPVER@/config_d
    fi
  fi
fi

#DEBHELPER#

exit 0
